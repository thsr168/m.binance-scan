  /* ============================================================
     分頁 UI 更新
  ============================================================ */
  function updatePaginationUI() {
    const total = allSymbols.length;
    const totalPages = total ? Math.ceil(total / PAGE_SIZE) : 0;

    if (!totalPages) {
      pageInfoEl.textContent = "第 0 / 0 頁";
      bottomPageInfoEl.textContent = "第 0 / 0 頁";
      prevBtn.disabled = nextBtn.disabled = true;
      bottomPrevBtn.disabled = bottomNextBtn.disabled = true;
      return;
    }

    const text = `第 ${currentPage + 1} / ${totalPages} 頁`;
    pageInfoEl.textContent = text;
    bottomPageInfoEl.textContent = text;

    prevBtn.disabled = bottomPrevBtn.disabled = currentPage === 0;
    nextBtn.disabled = bottomNextBtn.disabled = currentPage >= totalPages - 1;
  }


  /* ============================================================
     載入指定頁面（Lazy Load 版本）
  ============================================================ */
  async function loadPage(pageIndex) {
    const totalPages = Math.ceil(allSymbols.length / PAGE_SIZE);
    if (pageIndex < 0 || pageIndex >= totalPages) return;

    const token = ++currentLoadToken;
    currentPage = pageIndex;

    updatePaginationUI();

    // 清掉舊頁的圖表
    for (const child of Array.from(chartsEl.children)) {
      if (observer) observer.unobserve(child);
      unmountChart(child);
    }
    chartsEl.innerHTML = "";

    const start = pageIndex * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, allSymbols.length);
    const targets = allSymbols.slice(start, end);

    statusEl.textContent = `載入第 ${pageIndex + 1} 頁 …`;

    for (const sym of targets) {
      if (token !== currentLoadToken) return; // 中途中止

      const pct = tickerMap[sym]?.pct ?? 0;
      buildCard(sym, currentInterval, chartsEl, pct);
    }

    statusEl.textContent = `第 ${pageIndex + 1} 頁載入完成（往下滑會自動顯示 K 線）`;
  }


  /* ============================================================
     掃圖主流程（首頁 → K 線頁）
  ============================================================ */
  async function scan() {
    if (isLoading) return;
    isLoading = true;

    currentInterval = document.getElementById("home-interval").value;
    sortMode = document.getElementById("home-sort").value;

    goChartPage();
    statusEl.textContent = "取得合約列表中…";

    currentLoadToken++;

    try {
      // 只取一次 symbol
      if (allSymbols.length === 0) {
        allSymbols = await fetchFuturesSymbols();
      }

      statusEl.textContent = "取得 24h 漲跌幅…";
      tickerMap = await fetch24hTickers(allSymbols);

      if (sortMode === "symbol") {
        allSymbols.sort();
      } else {
        allSymbols.sort((a, b) => (tickerMap[b]?.pct ?? -999) - (tickerMap[a]?.pct ?? -999));
      }

      updatePaginationUI();

      isLoading = false;
      loadPage(0);

    } catch (err) {
      console.error("掃圖發生錯誤:", err);
      statusEl.textContent = "掃圖錯誤（請檢查 Console）。";
      isLoading = false;
    }
  }


  /* ============================================================
     Lazy Load 觀察器初始化
  ============================================================ */
  if ("IntersectionObserver" in window) {
    observer = new IntersectionObserver(
      entries => {
        for (const entry of entries) {
          const card = entry.target;

          if (entry.isIntersecting) {
            mountChart(card);
          } else {
            unmountChart(card);
          }
        }
      },
      { root: null, threshold: 0.1 }
    );
  } else {
    console.warn("你的瀏覽器不支援 IntersectionObserver（LazyLoad 將停用）");
  }


  /* ============================================================
     視窗大小調整 → 重新調整所有 chart 寬度
  ============================================================ */
  window.addEventListener("resize", () => {
    const cards = document.querySelectorAll(".chart-wrapper");
    cards.forEach(card => {
      if (card._chartInstance && card._chartDiv) {
        card._chartInstance.applyOptions({
          width: card._chartDiv.clientWidth
        });
      }
    });
  });


  /* ============================================================
     事件綁定
  ============================================================ */

  // 首頁的「開始掃圖」
  document.getElementById("home-start").addEventListener("click", scan);

  // 分頁：上方
  prevBtn.addEventListener("click", () => loadPage(currentPage - 1));
  nextBtn.addEventListener("click", () => loadPage(currentPage + 1));

  // 分頁：下方
  bottomPrevBtn.addEventListener("click", () => loadPage(currentPage - 1));
  bottomNextBtn.addEventListener("click", () => loadPage(currentPage + 1));

</script>

</body>
</html>
